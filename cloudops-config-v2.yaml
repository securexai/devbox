#cloud-config
# Ubuntu 25.10 - CloudOps Configuration (cloudops as default user)
#
# IMPORTANT: This is a TEMPLATE configuration with placeholder values.
# Customize the following sections before use:
#   - Git user configuration (lines ~619-650)
#   - Organization-specific aliases (if needed)
#
# Git Configuration Options:
#
#   Option 1: Environment Variables (recommended for automation)
#     multipass launch --name cloudops --cloud-init cloudops-config-v2.yaml \
#       -e GIT_USER_NAME="Your Name" \
#       -e GIT_USER_EMAIL="your@email.com" \
#       -e GIT_WORK_NAME="Work Name" \
#       -e GIT_WORK_EMAIL="work@company.com"
#
#   Option 2: Manual Edit
#     Edit the git configuration sections below and replace placeholders:
#       - CHANGEME / changeme@example.com (personal config)
#       - CHANGEME / changeme@example.com (work config)
#
# Validation:
#   cloud-init schema --config-file cloudops-config-v2.yaml --annotate
#
# Testing:
#   multipass launch --name test-cloudops --cloud-init cloudops-config-v2.yaml
#   multipass exec test-cloudops -- cloud-init status --wait
#   multipass exec test-cloudops -- cat /var/log/cloud-init.log
#
# Cleanup:
#   multipass delete test-cloudops && multipass purge

hostname: cloudops
timezone: America/Bogota
locale: en_US.UTF-8

# User configuration
# SECURITY NOTE: NOPASSWD sudo is convenient for development but reduces security.
# For production environments, remove NOPASSWD to require password authentication.
users:
  - name: cloudops
    gecos: CloudOps User
    shell: /bin/bash
    groups: [adm, cdrom, dip, plugdev, sudo]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: true
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM9mMEB83S3l0KQEQJrnfMQRX5JEvuKgh5oF4IfbElOr github.com.valium091@passmail.com

# Package management
# Cloud-init execution order: 1) update repos, 2) upgrade existing, 3) install new
package_update: false
package_upgrade: false

packages:
  - build-essential                  # Compilers and build tools (gcc, g++, make)
  - ca-certificates                  # SSL/TLS certificate authorities for HTTPS
  - curl                             # Command-line HTTP client for data transfer
  - bind9-dnsutils                   # DNS debugging tools (dig, nslookup) - renamed in Ubuntu 25.10
  - gh                               # GitHub CLI for repository management
  - git                              # Version control system
  - gnupg                            # GPG encryption and signing tools
  - htop                             # Enhanced process viewer
  - language-pack-en                 # English language support for system locales
  - locales                          # Locale data files for internationalization
  - lsb-release                      # Linux Standard Base version reporting
  - nano                             # Lightweight command-line text editor
  - net-tools                        # Network utilities (ifconfig, netstat)
  - openssh-client                   # SSH client for remote connections
  - openssh-server                   # SSH server for remote access
  - software-properties-common       # Scripts for managing software repositories
  - tree                             # Directory visualization
  - unzip                            # Extract files from ZIP archives
  - wget                             # Non-interactive HTTP/FTP file downloader

# Configuration files
write_files:
  # Custom .bashrc for cloudops user
  - path: /home/cloudops/.bashrc
    content: |
      # ~/.bashrc: executed by bash(1) for non-login shells.
      # see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)
      # for examples

      # If not running interactively, don't do anything
      case $- in
          *i*) ;;
            *) return;;
      esac

      # ============================================================================
      # Shell History Configuration
      # ============================================================================

      # don't put duplicate lines or lines starting with space in the history.
      # See bash(1) for more options
      HISTCONTROL=ignoreboth

      # append to the history file, don't overwrite it
      shopt -s histappend

      # for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
      HISTSIZE=10000
      HISTFILESIZE=20000

      # ============================================================================
      # Shell Options
      # ============================================================================

      # check the window size after each command and, if necessary,
      # update the values of LINES and COLUMNS.
      shopt -s checkwinsize

      # If set, the pattern "**" used in a pathname expansion context will
      # match all files and zero or more directories and subdirectories.
      shopt -s globstar

      # make less more friendly for non-text input files, see lesspipe(1)
      [ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

      # ============================================================================
      # Prompt Configuration
      # ============================================================================

      # set variable identifying the chroot you work in (used in the prompt below)
      if [ -z "${debian_chroot:-}" ] && [ -r /etc/debian_chroot ]; then
          debian_chroot=$(cat /etc/debian_chroot)
      fi

      # set a fancy prompt (non-color, unless we know we "want" color)
      case "$TERM" in
          xterm-color|*-256color) color_prompt=yes;;
      esac

      # uncomment for a colored prompt, if the terminal has the capability; turned
      # off by default to not distract the user: the focus in a terminal window
      # should be on the output of commands, not on the prompt
      #force_color_prompt=yes

      if [ -n "$force_color_prompt" ]; then
          if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
      	# We have color support; assume it's compliant with Ecma-48
      	# (ISO/IEC-6429). (Lack of such support is extremely rare, and such
      	# a case would tend to support setf rather than setaf.)
      	color_prompt=yes
          else
      	color_prompt=
          fi
      fi

      if [ "$color_prompt" = yes ]; then
          PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
      else
          PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
      fi
      unset color_prompt force_color_prompt

      # If this is an xterm set the title to user@host:dir
      case "$TERM" in
      xterm*|rxvt*)
          PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
          ;;
      *)
          ;;
      esac

      # ============================================================================
      # Color Support
      # ============================================================================

      # enable color support of ls and also add handy aliases
      if [ -x /usr/bin/dircolors ]; then
          test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
          alias ls='ls --color=auto'
          #alias dir='dir --color=auto'
          #alias vdir='vdir --color=auto'

          alias grep='grep --color=auto'
          alias fgrep='fgrep --color=auto'
          alias egrep='egrep --color=auto'
      fi

      # colored GCC warnings and errors
      #export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

      # ============================================================================
      # Built-in Aliases
      # ============================================================================

      # Add an "alert" alias for long running commands.  Use like so:
      #   sleep 10; alert
      alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'

      # ============================================================================
      # Bash Completion
      # ============================================================================

      # enable programmable completion features (you don't need to enable
      # this, if it's already enabled in /etc/bash.bashrc and /etc/profile
      # sources /etc/bash.bashrc).
      if ! shopt -oq posix; then
        if [ -f /usr/share/bash-completion/bash_completion ]; then
          . /usr/share/bash-completion/bash_completion
        elif [ -f /etc/bash_completion ]; then
          . /etc/bash_completion
        fi
      fi

      # ============================================================================
      # User Aliases
      # ============================================================================

      # Alias definitions.
      # You may want to put all your additions into a separate file like
      # ~/.bash_aliases, instead of adding them here directly.
      # See /usr/share/doc/bash-doc/examples in the bash-doc package.

      if [ -f ~/.bash_aliases ]; then
          . ~/.bash_aliases
      fi

      # ============================================================================
      # Tool Initialization
      # ============================================================================

      # === NVM (Node Version Manager) - Lazy Loading ===
      # Lazy load NVM to improve shell startup time (saves ~200-500ms)
      # NVM will be loaded on first use of nvm, node, npm, or npx commands
      #
      # IMPORTANT - Tab Completion Behavior:
      # Tab completion for npm/npx will NOT work until you run one of these commands
      # for the first time in your shell session. This is a trade-off for faster startup.
      #
      # Example workflow:
      #   $ npm <TAB>        # ‚Üê Tab completion won't work yet
      #   $ npm --version    # ‚Üê First use loads NVM
      #   $ npm <TAB>        # ‚Üê Now tab completion works for rest of session
      #
      # After first use, completion works normally for all npm/npx commands.
      # NVM and node tab completion work immediately as they load the completion system.
      export NVM_DIR="$HOME/.nvm"

      # Define the NVM loader function once (DRY principle)
      _load_nvm() {
          unset -f nvm node npm npx _load_nvm
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
      }

      # Lazy load wrappers - each command loads NVM on first use
      nvm() { _load_nvm; nvm "$@"; }
      node() { _load_nvm; node "$@"; }

      npm() {
        _load_nvm
        if command -v npm &>/dev/null; then
          npm "$@"
        else
          echo "npm not found. Install Node.js via 'nvm install node'" >&2
          return 127
        fi
      }

      npx() {
        _load_nvm
        if command -v npx &>/dev/null; then
          npx "$@"
        else
          echo "npx not found. Install Node.js via 'nvm install node'" >&2
          return 127
        fi
      }

      # === Bun JavaScript Runtime ===
      export BUN_INSTALL="$HOME/.bun"
      export PATH="$BUN_INSTALL/bin:$PATH"

      # ============================================================================
      # Lazy-Loading Completions (improves shell startup time)
      # ============================================================================

      # kubectl completion - one-time load on first use
      kubectl() {
          unset -f kubectl
          if command -v kubectl &>/dev/null; then
              source <(command kubectl completion bash 2>/dev/null)
              complete -o default -F __start_kubectl k
          fi
          kubectl "$@"
      }

      # helm completion - one-time load on first use
      helm() {
          unset -f helm
          if [ -f /etc/bash_completion.d/helm ]; then
              source /etc/bash_completion.d/helm
          elif command -v helm &>/dev/null; then
              source <(command helm completion bash 2>/dev/null)
          fi
          helm "$@"
      }

      # ============================================================================
      # PATH Configuration (consolidated)
      # ============================================================================

      # Local binaries (Terraform, custom tools)
      export PATH="$HOME/.local/bin:$PATH"

      # ============================================================================
      # Tool-Specific Configuration
      # ============================================================================

      # === Terraform ===
      if command -v terraform &>/dev/null; then
          complete -C "$(command -v terraform)" terraform
      fi

      # === kubectl Configuration ===
      # Only set VS Code as kubectl editor if both tools are available
      if command -v code &>/dev/null && command -v kubectl &>/dev/null; then
          export KUBE_EDITOR="code --wait"
      fi

      # === Cargo (Rust) Environment ===
      if [ -f "$HOME/.cargo/env" ]; then
          . "$HOME/.cargo/env"
      fi

      # ============================================================================
      # Devbox Global Environment
      # ============================================================================

      # Activate devbox global packages (jq, yq, gh, etc.)
      # Note: May not be available on first boot until cloud-init completes
      # Only activate if devbox is installed to avoid errors on first boot
      if command -v devbox &>/dev/null; then
          eval "$(devbox global shellenv)" 2>/dev/null || true
      fi

      # ============================================================================
      # pnpm Configuration
      # ============================================================================

      # pnpm global package manager
      # Installed via 'pnpm setup' during cloud-init
      # Only add PNPM_HOME to PATH if directory exists (defensive check)
      export PNPM_HOME="/home/cloudops/.local/share/pnpm"
      if [ -d "$PNPM_HOME" ]; then
        case ":$PATH:" in
          *":$PNPM_HOME:"*) ;;
          *) export PATH="$PNPM_HOME:$PATH" ;;
        esac
      fi
      # pnpm end

  # Custom .bash_aliases for cloudops user
  - path: /home/cloudops/.bash_aliases
    content: |
      # ~/.bash_aliases
      # Custom aliases for enhanced productivity

      # ============================================================================
      # Navigation & Safety
      # ============================================================================

      # Directory navigation shortcuts
      alias ..='cd ..'
      alias ...='cd ../..'
      alias ....='cd ../../..'
      alias .....='cd ../../../..'
      alias -- -='cd -'  # Go back to previous directory

      # Safety aliases (interactive mode for destructive operations)
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'
      alias ln='ln -i'

      # Enhanced ls commands
      alias l='ls -CF'
      alias la='ls -A'
      alias ll='ls -alF'
      alias lh='ls -lh'
      alias lt='ls -ltr'  # Sort by time, most recent last
      alias lsize='ls -lhS'  # Sort by size

      # ============================================================================
      # Git Shortcuts
      # ============================================================================

      alias g='git'
      alias gs='git status'
      alias gss='git status -s'  # Short format
      alias ga='git add'
      alias gaa='git add --all'
      alias gap='git add -p'  # Interactive staging
      alias gc='git commit'
      alias gcm='git commit -m'
      alias gca='git commit --amend'
      alias gcan='git commit --amend --no-edit'
      alias gp='git push'
      alias gpf='git push --force-with-lease'  # Safer force push
      alias gl='git pull'
      alias gf='git fetch'
      alias gco='git checkout'
      alias gcb='git checkout -b'
      alias gb='git branch'
      alias gba='git branch -a'
      alias gbd='git branch -d'
      alias gbD='git branch -D'
      alias gd='git diff'
      alias gds='git diff --staged'
      alias glog='git log --oneline --graph --decorate'
      alias gloga='git log --oneline --graph --decorate --all'
      alias glogp='git log --pretty=format:"%h %ad | %s%d [%an]" --graph --date=short'
      alias gstash='git stash'
      alias gstashp='git stash pop'
      alias gm='git merge'
      alias gr='git rebase'
      alias gri='git rebase -i'
      alias grc='git rebase --continue'
      alias gra='git rebase --abort'
      alias greset='git reset'
      alias gresethard='git reset --hard'
      alias gclean='git clean -fd'
      alias gshow='git show'
      alias gtag='git tag'

      # ============================================================================
      # Podman Aliases
      # ============================================================================

      alias p='podman'
      alias pps='podman ps'
      alias ppsa='podman ps -a'
      alias pimg='podman images'
      alias pbuild='podman build'
      alias prun='podman run'
      alias prm='podman rm'
      alias prmi='podman rmi'
      alias pstop='podman stop'
      alias pstart='podman start'
      alias prestart='podman restart'
      alias pexec='podman exec -it'
      alias plog='podman logs'
      alias plogf='podman logs -f'
      alias pinspect='podman inspect'
      alias ppull='podman pull'
      alias ppush='podman push'
      alias pprune='podman system prune -a'
      alias pvolume='podman volume'
      alias pnetwork='podman network'
      alias ppod='podman pod'

      # Podman compose aliases
      alias pc='podman-compose'
      alias pcup='podman-compose up -d'
      alias pcdown='podman-compose down'
      alias pclogs='podman-compose logs'
      alias pclogsf='podman-compose logs -f'
      alias pcrestart='podman-compose restart'
      alias pcbuild='podman-compose build'

      # ============================================================================
      # Docker Aliases
      # ============================================================================

      alias d='docker'
      alias dps='docker ps'
      alias dpsa='docker ps -a'
      alias dimg='docker images'
      alias dbuild='docker build'
      alias drun='docker run'
      alias drm='docker rm'
      alias drmi='docker rmi'
      alias dstop='docker stop'
      alias dstart='docker start'
      alias drestart='docker restart'
      alias dexec='docker exec -it'
      alias dlog='docker logs'
      alias dlogf='docker logs -f'
      alias dinspect='docker inspect'
      alias dpull='docker pull'
      alias dpush='docker push'
      alias dprune='docker system prune -a'
      alias dvolume='docker volume'
      alias dnetwork='docker network'

      # Docker compose aliases
      alias dc='docker-compose'
      alias dcup='docker-compose up -d'
      alias dcdown='docker-compose down'
      alias dclogs='docker-compose logs'
      alias dclogsf='docker-compose logs -f'
      alias dcrestart='docker-compose restart'
      alias dcbuild='docker-compose build'

      # ============================================================================
      # Kubernetes & kubectl Aliases
      # ============================================================================

      alias k='kubectl'
      alias kgp='kubectl get pods'
      alias kgpa='kubectl get pods --all-namespaces'
      alias kgd='kubectl get deployments'
      alias kgs='kubectl get services'
      alias kgn='kubectl get nodes'
      alias kgi='kubectl get ingress'
      alias kgpvc='kubectl get pvc'
      alias kgcm='kubectl get configmaps'
      alias kgsec='kubectl get secrets'

      alias kdesc='kubectl describe'
      alias kdescp='kubectl describe pod'
      alias kdescd='kubectl describe deployment'
      alias kdescs='kubectl describe service'

      alias klog='kubectl logs'
      alias klogf='kubectl logs -f'
      alias klogp='kubectl logs -p'  # Previous container

      alias kexec='kubectl exec -it'
      alias kpf='kubectl port-forward'
      alias kdel='kubectl delete'
      alias kapp='kubectl apply -f'
      alias kedit='kubectl edit'

      alias kctx='kubectl config current-context'
      alias kns='kubectl config set-context --current --namespace'
      alias kgetns='kubectl get namespaces'

      # ============================================================================
      # Azure CLI Aliases
      # ============================================================================

      alias azlogin='az login'
      alias azaccount='az account show'
      alias azlist='az account list --output table'
      alias azrg='az group list --output table'
      alias azaks='az aks list --output table'
      alias aksget='az aks get-credentials'

      # Add organization-specific aliases here
      # Example:
      # alias azsetdev='az account set --subscription YOUR_SUBSCRIPTION_ID'
      # alias kdev='az aks get-credentials --resource-group YOUR_RG --name YOUR_CLUSTER'

      # ============================================================================
      # Terraform Aliases
      # ============================================================================

      alias tf='terraform'
      alias tfinit='terraform init'
      alias tfplan='terraform plan'
      alias tfapply='terraform apply'
      alias tfdestroy='terraform destroy'
      alias tfvalidate='terraform validate'
      alias tffmt='terraform fmt'
      alias tfoutput='terraform output'
      alias tfshow='terraform show'
      alias tfstate='terraform state'
      alias tfws='terraform workspace'
      alias tfwslist='terraform workspace list'
      alias tfwsselect='terraform workspace select'
      alias tfwsnew='terraform workspace new'

      # ============================================================================
      # pnpm & Node.js Aliases
      # ============================================================================

      alias pn='pnpm'
      alias pi='pnpm install'
      alias pd='pnpm dev'
      alias pb='pnpm build'
      alias pt='pnpm test'
      alias pl='pnpm lint'
      alias plf='pnpm lint:fix'
      alias pstart='pnpm start'
      alias ppr='pnpm prettier:write'
      alias pcheck='pnpm check-types'

      # ============================================================================
      # System & Utilities
      # ============================================================================

      # Disk usage
      alias df='df -h'
      alias du='du -h'
      alias dus='du -sh'

      # Process management
      alias psg='ps aux | grep -v grep | grep -i -e VSZ -e'
      alias psgrep='ps aux | grep'

      # Network
      alias ports='netstat -tulanp'
      alias myip='curl ifconfig.me'

      # History
      alias h='history'
      alias hg='history | grep'

      # Quick directory jumps
      # Add your project-specific shortcuts here
      # Example:
      # alias myproject='cd ~/code/myproject'

      # Reload bash config
      alias reload='source ~/.bashrc'
      alias editbash='code ~/.bashrc ~/.bash_aliases'

      # ============================================================================
      # Miscellaneous
      # ============================================================================

      # Make directory and cd into it
      mkcd() {
          mkdir -p "$1" && cd "$1"
      }

      # Extract compressed files
      extract() {
          if [ -f "$1" ]; then
              case "$1" in
                  *.tar.bz2)   tar xjf "$1"     ;;
                  *.tar.gz)    tar xzf "$1"     ;;
                  *.bz2)       bunzip2 "$1"     ;;
                  *.rar)       unrar x "$1"     ;;
                  *.gz)        gunzip "$1"      ;;
                  *.tar)       tar xf "$1"      ;;
                  *.tbz2)      tar xjf "$1"     ;;
                  *.tgz)       tar xzf "$1"     ;;
                  *.zip)       unzip "$1"       ;;
                  *.Z)         uncompress "$1"  ;;
                  *.7z)        7z x "$1"        ;;
                  *)           echo "'$1' cannot be extracted via extract()" ;;
              esac
          else
              echo "'$1' is not a valid file"
          fi
      }

      # Find files by name
      ff() {
          find . -type f -iname "*$1*"
      }

      # Find directories by name
      fdir() {
          find . -type d -iname "*$1*"
      }

  # Git configuration - Personal (template)
  # Note: This template will be processed by runcmd to support environment variables
  # TEMPLATE: Replace YOUR_NAME and YOUR_EMAIL with your actual information
  # OR: Pass via environment variables: GIT_USER_NAME and GIT_USER_EMAIL
  - path: /home/cloudops/.gitconfig.template
    content: |
      [user]
          name = __GIT_USER_NAME__
          email = __GIT_USER_EMAIL__
      [includeIf "gitdir/i:~/code/work/**"]
          path = ~/code/work/.gitconfig
      [core]
          editor = code --wait
          hooksPath = ~/.git-hooks
          autocrlf = input
      [init]
          defaultBranch = main
      [pull]
          rebase = true
      [fetch]
          prune = true
      [push]
          default = current
          autoSetupRemote = true
      [alias]
          st = status -sb
          lg = log --graph --oneline --decorate --all

  # Git configuration - Work (template)
  # Note: This template will be processed by runcmd to support environment variables
  # TEMPLATE: Replace WORK_NAME and WORK_EMAIL with your work information
  # OR: Pass via environment variables: GIT_WORK_NAME and GIT_WORK_EMAIL
  - path: /tmp/gitconfig-work.template
    content: |
      [user]
          name = __GIT_WORK_NAME__
          email = __GIT_WORK_EMAIL__

  # Devbox template: Node.js/TypeScript Web Application
  - path: /home/cloudops/.devbox-templates/nodejs-webapp.json
    content: |
      {
        "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/main/devbox.schema.json",
        "packages": {
          "nodejs": "22.14.0",
          "pnpm": "10.11.0",
          "typescript": "5.7.3"
        },
        "env": {
          "PATH": "$PWD/node_modules/.bin:$PATH",
          "NODE_ENV": "development"
        },
        "shell": {
          "init_hook": [
            "echo 'Node.js Web App Environment'",
            "echo 'Node: $(node --version)'",
            "echo 'pnpm: $(pnpm --version)'",
            "echo 'TypeScript: $(tsc --version)'",
            "echo ''",
            "echo 'Run: pnpm install  # Install dependencies'",
            "echo 'Run: pnpm dev      # Start development server'"
          ],
          "scripts": {
            "install": "pnpm install",
            "dev": "pnpm dev",
            "build": "pnpm build",
            "test": "pnpm test"
          }
        }
      }

  # Devbox template: Python FastAPI/Flask Application
  - path: /home/cloudops/.devbox-templates/python-api.json
    content: |
      {
        "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/main/devbox.schema.json",
        "packages": {
          "python-full": "3.12.6",
          "poetry": "latest"
        },
        "env": {
          "VIRTUAL_ENV": "$PWD/.venv",
          "PATH": "$PWD/.venv/bin:$PATH",
          "PYTHONPATH": "$PWD"
        },
        "shell": {
          "init_hook": [
            "echo 'Python API Environment'",
            "echo 'Python: $(python --version)'",
            "echo 'Poetry: $(poetry --version 2>/dev/null || echo not configured)'",
            "echo ''",
            "echo 'Run: poetry install  # Install dependencies'",
            "echo 'Run: poetry shell    # Activate virtual environment'",
            "if [ ! -d .venv ]; then python -m venv .venv; fi",
            "source .venv/bin/activate"
          ],
          "scripts": {
            "install": "poetry install",
            "dev": "poetry run uvicorn main:app --reload",
            "test": "poetry run pytest"
          }
        }
      }

  # Devbox template: Go Service/API
  - path: /home/cloudops/.devbox-templates/go-service.json
    content: |
      {
        "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/main/devbox.schema.json",
        "packages": {
          "go": "1.23.5",
          "air": "latest"
        },
        "env": {
          "GOENV": "off",
          "CGO_ENABLED": "0",
          "GOOS": "linux",
          "GOARCH": "amd64"
        },
        "shell": {
          "init_hook": [
            "echo 'Go Service Environment'",
            "echo 'Go: $(go version)'",
            "echo ''",
            "echo 'Run: go mod download  # Download dependencies'",
            "echo 'Run: go run main.go   # Run application'",
            "echo 'Run: air              # Hot reload with air'"
          ],
          "scripts": {
            "install": "go mod download",
            "dev": "air",
            "build": "go build -o bin/app .",
            "test": "go test ./..."
          }
        }
      }

  # Devbox template: Rust CLI/Systems Tool
  - path: /home/cloudops/.devbox-templates/rust-cli.json
    content: |
      {
        "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/main/devbox.schema.json",
        "packages": {
          "rustc": "1.85.0",
          "cargo": "1.85.0",
          "rust-analyzer": "latest"
        },
        "shell": {
          "init_hook": [
            "echo 'Rust Development Environment'",
            "echo 'Rust: $(rustc --version)'",
            "echo 'Cargo: $(cargo --version)'",
            "echo ''",
            "echo 'Run: cargo build     # Build project'",
            "echo 'Run: cargo run       # Run project'",
            "echo 'Run: cargo test      # Run tests'"
          ],
          "scripts": {
            "build": "cargo build",
            "release": "cargo build --release",
            "dev": "cargo run",
            "test": "cargo test"
          }
        }
      }

  # Devbox template: Full-Stack (Multi-language)
  - path: /home/cloudops/.devbox-templates/fullstack.json
    content: |
      {
        "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/main/devbox.schema.json",
        "packages": {
          "nodejs": "22.14.0",
          "pnpm": "10.11.0",
          "python-full": "3.12.6",
          "postgresql": "16",
          "redis": "7.2"
        },
        "env": {
          "PATH": "$PWD/node_modules/.bin:$PWD/.venv/bin:$PATH",
          "DATABASE_URL": "postgresql://localhost:5432/devdb",
          "REDIS_URL": "redis://localhost:6379"
        },
        "shell": {
          "init_hook": [
            "echo 'Full-Stack Development Environment'",
            "echo 'Node: $(node --version)'",
            "echo 'Python: $(python --version)'",
            "echo 'PostgreSQL: $(postgres --version 2>/dev/null | head -1)'",
            "echo 'Redis: $(redis-server --version 2>/dev/null | head -1)'",
            "echo ''",
            "echo 'Services available:'",
            "echo '  - PostgreSQL (port 5432)'",
            "echo '  - Redis (port 6379)'",
            "echo ''",
            "echo 'Frontend: cd frontend && pnpm install && pnpm dev'",
            "echo 'Backend: cd backend && poetry install && poetry run uvicorn main:app --reload'"
          ],
          "scripts": {
            "db:start": "pg_ctl start -D $PWD/.devbox/virtenv/postgresql/data",
            "db:stop": "pg_ctl stop -D $PWD/.devbox/virtenv/postgresql/data",
            "redis:start": "redis-server --daemonize yes",
            "redis:stop": "redis-cli shutdown"
          }
        }
      }

  # Maintenance script: Update global tools
  - path: /home/cloudops/bin/update-global-tools.sh
    content: |
      #!/bin/bash
      # Update global Devbox tools and Claude CLI

      set -e

      # Source bashrc to get PNPM_HOME and devbox environment
      if [ -f "$HOME/.bashrc" ]; then
        source "$HOME/.bashrc"
      fi

      echo "üì¶ Updating global Devbox packages..."
      devbox global update

      echo ""
      echo "ü§ñ Updating Claude CLI..."
      if [ -n "$PNPM_HOME" ]; then
        pnpm update -g @anthropic-ai/claude-code
      else
        echo "ERROR: PNPM_HOME not set. Please run: source ~/.bashrc" >&2
        exit 1
      fi

      echo ""
      echo "‚úÖ Update complete! Current versions:"
      echo "  Node.js: $(node --version 2>/dev/null || echo 'not found')"
      echo "  pnpm: $(pnpm --version 2>/dev/null || echo 'not found')"
      echo "  Claude CLI: $(claude --version 2>/dev/null || echo 'not found')"

  # Maintenance script: Health check
  - path: /home/cloudops/bin/check-devbox-health.sh
    content: |
      #!/bin/bash
      # Verify Devbox and Claude CLI setup

      echo "üîç Checking Devbox global setup..."
      echo ""

      # 1. Check Devbox is installed
      echo "1. Devbox installation:"
      if command -v devbox &>/dev/null; then
        echo "   ‚úÖ devbox $(devbox version)"
      else
        echo "   ‚ùå devbox NOT installed"
      fi
      echo ""

      # 2. Check global packages
      echo "2. Devbox global packages:"
      devbox global list
      echo ""

      # 3. Check Node.js
      echo "3. Node.js:"
      if command -v node &>/dev/null; then
        echo "   ‚úÖ $(node --version) at $(which node)"
      else
        echo "   ‚ùå node NOT found in PATH"
      fi
      echo ""

      # 4. Check pnpm
      echo "4. pnpm:"
      if command -v pnpm &>/dev/null; then
        echo "   ‚úÖ pnpm $(pnpm --version) at $(which pnpm)"
      else
        echo "   ‚ùå pnpm NOT found in PATH"
      fi
      echo ""

      # 5. Check Claude CLI
      echo "5. Claude CLI:"
      if command -v claude &>/dev/null; then
        echo "   ‚úÖ $(claude --version) at $(which claude)"
      else
        echo "   ‚ùå claude NOT found in PATH"
      fi
      echo ""

      # 6. Check shellenv activation
      echo "6. Shellenv activation:"
      if echo $PATH | grep -q "devbox/global"; then
        echo "   ‚úÖ Shellenv is activated"
      else
        echo "   ‚ö†Ô∏è  Shellenv NOT activated - run: source ~/.bashrc"
      fi
      echo ""

      # 7. Check PNPM_HOME
      echo "7. PNPM_HOME:"
      if [ -n "$PNPM_HOME" ]; then
        echo "   ‚úÖ PNPM_HOME=$PNPM_HOME"
      else
        echo "   ‚ö†Ô∏è  PNPM_HOME not set - run: source ~/.bashrc"
      fi
      echo ""

      # 8. Check templates
      echo "8. Available templates:"
      if [ -d ~/.devbox-templates ]; then
        ls -1 ~/.devbox-templates/ 2>/dev/null | sed 's/^/   ‚úÖ /' || echo "   ‚ö†Ô∏è  No templates found"
      else
        echo "   ‚ö†Ô∏è  Template directory not found"
      fi
      echo ""

      echo "üèÅ Health check complete!"

  # Devbox Quickstart Documentation
  - path: /home/cloudops/.devbox-quickstart.md
    content: |
      # Devbox Quickstart Guide

      Devbox creates isolated, reproducible development environments using Nix.

      ## Quick Start

      ### 1. Initialize a New Project

      ```bash
      # Create project directory
      mkdir my-project && cd my-project

      # Initialize devbox (creates devbox.json)
      devbox init

      # Add packages
      devbox add nodejs@22.14.0 pnpm@10.11.0

      # Enter the environment
      devbox shell
      ```

      ### 2. Use a Template

      Pre-configured templates are available in `~/.devbox-templates/`:

      ```bash
      # Copy a template
      cp ~/.devbox-templates/nodejs-webapp.json devbox.json

      # Or for Python
      cp ~/.devbox-templates/python-api.json devbox.json

      # Or for Go
      cp ~/.devbox-templates/go-service.json devbox.json

      # Enter the environment
      devbox shell
      ```

      ### 3. Global Tools (Already Configured)

      Global tools are available in all shells:
      - `jq` - JSON processor
      - `yq` - YAML processor
      - `gh` - GitHub CLI (already installed via apt)

      To add more global tools:
      ```bash
      devbox global add <package-name>
      ```

      ## Common Commands

      ```bash
      devbox add <package>           # Add package to project
      devbox remove <package>        # Remove package
      devbox shell                   # Enter development environment
      devbox run <script>            # Run script from devbox.json
      devbox services start          # Start services (databases, etc.)
      devbox services stop           # Stop services
      devbox update                  # Update all packages
      devbox search <query>          # Search available packages
      ```

      ## Project Structure

      ```text
      my-project/
      ‚îú‚îÄ‚îÄ devbox.json          # Package definitions and scripts
      ‚îú‚îÄ‚îÄ devbox.lock          # Lock file (commit to git)
      ‚îú‚îÄ‚îÄ .devbox/             # Local cache (add to .gitignore)
      ‚îî‚îÄ‚îÄ your-code/
      ```

      ## devbox.json Structure

      ```json
      {
        "packages": {
          "nodejs": "22.14.0",    # Pin specific versions
          "python": "3.12.6"
        },
        "env": {
          "PATH": "$PWD/bin:$PATH",  # Environment variables
          "MY_VAR": "value"
        },
        "shell": {
          "init_hook": [
            "npm install",           # Commands run on 'devbox shell'
            "echo 'Ready!'"
          ],
          "scripts": {
            "dev": "npm run dev",    # Run with 'devbox run dev'
            "test": "npm test"
          }
        }
      }
      ```

      ## Best Practices

      1. **Always pin versions** for reproducibility
         ```json
         "nodejs": "22.14.0"  ‚úì Good
         "nodejs": "latest"   ‚úó Avoid
         ```

      2. **Commit devbox.json and devbox.lock** to version control

      3. **Add .devbox/ to .gitignore**
         ```bash
         echo ".devbox/" >> .gitignore
         ```

      4. **Use scripts for common tasks**
         ```json
         "scripts": {
           "dev": "npm run dev",
           "test": "npm test",
           "build": "npm run build"
         }
         ```

      5. **Keep project-specific packages in devbox.json**
         - Language runtimes: Node, Python, Go, Rust
         - Project dependencies: PostgreSQL, Redis, etc.

      6. **Keep universal tools in devbox global**
         - CLI tools: jq, yq, fd, ripgrep
         - Cloud CLIs: awscli, kubectl, terraform

      ## Caching & Performance

      Devbox leverages Nix caching for fast installations:

      - **First install**: Downloads and caches packages (2-5 min)
      - **Subsequent installs**: Uses cache (10-30 sec)
      - **Cache location**: `/nix/store` (shared across all projects)

      ## Troubleshooting

      ### "Package not found"
      ```bash
      # Search for available packages
      devbox search nodejs

      # Use exact package name from search results
      devbox add nodejs@22.14.0
      ```

      ### "Command not found" after adding package
      ```bash
      # Exit and re-enter the shell
      exit
      devbox shell
      ```

      ### Clear local cache
      ```bash
      rm -rf .devbox/
      devbox shell  # Rebuilds cache
      ```

      ### View package details
      ```bash
      devbox info <package-name>
      ```

      ## Resources

      - **Documentation**: https://www.jetify.com/devbox/docs
      - **Package Search**: https://www.nixhub.io
      - **Templates**: `ls ~/.devbox-templates/`
      - **Examples**: https://github.com/jetify-com/devbox-examples

      ## Example Workflows

      ### Node.js Project
      ```bash
      mkdir my-app && cd my-app
      cp ~/.devbox-templates/nodejs-webapp.json devbox.json
      devbox shell
      npm init -y
      npm install express
      npm start
      ```

      ### Python API
      ```bash
      mkdir my-api && cd my-api
      cp ~/.devbox-templates/python-api.json devbox.json
      devbox shell
      poetry init
      poetry add fastapi uvicorn
      poetry run uvicorn main:app --reload
      ```

      ### Go Service
      ```bash
      mkdir my-service && cd my-service
      cp ~/.devbox-templates/go-service.json devbox.json
      devbox shell
      go mod init github.com/user/my-service
      go run main.go
      ```

      ---

      **Questions?** Check https://www.jetify.com/devbox/docs or run `devbox help`

  # Netplan configuration for bridge networking (commented template)
  - path: /etc/netplan/60-bridge.yaml
    content: |
      # Bridge Network Configuration
      # Edit this file to enable bridge networking
      #
      # network:
      #   version: 2
      #   ethernets:
      #     eth0:
      #       dhcp4: false
      #       dhcp6: false
      #   bridges:
      #     br0:
      #       interfaces: [eth0]
      #       dhcp4: true
      #       # Or use static IP:
      #       # addresses: [192.168.1.100/24]
      #       # routes:
      #       #   - to: default
      #       #     via: 192.168.1.1
      #       # nameservers:
      #       #   addresses: [8.8.8.8, 8.8.4.4]
      #
      # After editing, apply with: sudo netplan apply

# Commands to run after setup
runcmd:
  # Execute all setup commands in a single logged block with error handling
  - |
    {
      set -eu
      echo "=== CloudOps Setup Started: $(date) ==="

      # Create directory structure
      echo "Creating directory structure..."
      mkdir -p /home/cloudops/code/work /home/cloudops/code/personal

      # Move work git config template to proper location
      [ -f /tmp/gitconfig-work.template ] && \
        mv /tmp/gitconfig-work.template /home/cloudops/code/work/.gitconfig.template

      # Set ownership for all cloudops files
      echo "Setting file ownership..."
      chown -R cloudops:cloudops /home/cloudops

      # Set file permissions explicitly (permissions field causes YAML 1.1 parsing issues)
      echo "Setting file permissions..."
      chmod 644 /home/cloudops/.bashrc
      chmod 644 /home/cloudops/.bash_aliases
      chmod 644 /home/cloudops/.gitconfig.template
      chmod 644 /home/cloudops/code/work/.gitconfig.template
      chmod 644 /etc/netplan/60-bridge.yaml

      # Set permissions for devbox templates and documentation
      mkdir -p /home/cloudops/.devbox-templates
      chown cloudops:cloudops /home/cloudops/.devbox-templates
      chmod 755 /home/cloudops/.devbox-templates
      if ls /home/cloudops/.devbox-templates/*.json >/dev/null 2>&1; then
        chmod 644 /home/cloudops/.devbox-templates/*.json
      fi
      chmod 644 /home/cloudops/.devbox-quickstart.md

      # Set permissions for maintenance scripts
      mkdir -p /home/cloudops/bin
      chown cloudops:cloudops /home/cloudops/bin
      chmod 755 /home/cloudops/bin/update-global-tools.sh
      chmod 755 /home/cloudops/bin/check-devbox-health.sh

      # Process git configuration templates with environment variables
      echo "Processing git configuration templates..."

      # Set default values if environment variables are not provided
      GIT_USER_NAME="${GIT_USER_NAME:-CHANGEME}"
      GIT_USER_EMAIL="${GIT_USER_EMAIL:-changeme@example.com}"
      GIT_WORK_NAME="${GIT_WORK_NAME:-CHANGEME}"
      GIT_WORK_EMAIL="${GIT_WORK_EMAIL:-changeme@example.com}"

      # Separate warnings for clarity
      if [ "$GIT_USER_NAME" = "CHANGEME" ] || [ "$GIT_USER_EMAIL" = "changeme@example.com" ]; then
        echo "WARNING - Personal git config using placeholder values. Set GIT_USER_NAME and GIT_USER_EMAIL" >&2
      fi

      if [ "$GIT_WORK_NAME" = "CHANGEME" ] || [ "$GIT_WORK_EMAIL" = "changeme@example.com" ]; then
        echo "WARNING - Work git config using placeholder values. Set GIT_WORK_NAME and GIT_WORK_EMAIL" >&2
      fi

      # Process git config templates using sed
      process_git_template() {
        local template="$1"
        local output="$2"
        local name="$3"
        local email="$4"
        local label="$5"

        sed -e "s|__GIT_USER_NAME__|${name}|g" \
            -e "s|__GIT_USER_EMAIL__|${email}|g" \
            -e "s|__GIT_WORK_NAME__|${name}|g" \
            -e "s|__GIT_WORK_EMAIL__|${email}|g" \
            "$template" > "$output"

        chown cloudops:cloudops "$output"
        chmod 644 "$output"
        rm -f "$template"
        echo "${label} git config created with user: ${name}"
      }

      # Process personal and work git configs
      [ -f /home/cloudops/.gitconfig.template ] && \
        process_git_template /home/cloudops/.gitconfig.template /home/cloudops/.gitconfig \
          "$GIT_USER_NAME" "$GIT_USER_EMAIL" "Personal"

      [ -f /home/cloudops/code/work/.gitconfig.template ] && \
        process_git_template /home/cloudops/code/work/.gitconfig.template /home/cloudops/code/work/.gitconfig \
          "$GIT_WORK_NAME" "$GIT_WORK_EMAIL" "Work"

      # Add auto-switch to cloudops user (idempotent)
      echo "Configuring auto-switch to cloudops user..."
      if ! grep -q "CLOUDOPS_SWITCHED" /home/ubuntu/.bashrc 2>/dev/null; then
        echo 'if [ -t 0 ] && [ "$USER" = "ubuntu" ] && [ -z "$CLOUDOPS_SWITCHED" ]; then export CLOUDOPS_SWITCHED=1; exec sudo -i -u cloudops; fi' >> /home/ubuntu/.bashrc
      fi

      # Clean up package cache to reduce disk usage
      echo "Cleaning package cache..."
      apt-get clean || echo "WARNING - apt-get clean failed (non-critical)"
      rm -rf /var/cache/apt/archives/* || echo "WARNING - Cache cleanup failed (non-critical)"

      # Install Determinate Nix (system-wide, multi-user mode)
      echo "Installing Determinate Nix..."
      if ! command -v nix &>/dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | \
          sh -s -- install --no-confirm \
          --extra-conf "auto-optimise-store = true" \
          --extra-conf "trusted-users = root cloudops" \
          --extra-conf "experimental-features = nix-command flakes" || \
          echo "WARNING - Nix installation failed" >&2

        # Source Nix profile to make it available in current shell
        # Set HOME temporarily since runcmd doesn't have it set
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          HOME=/root . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        fi

        # Verify Nix installation
        if command -v nix &>/dev/null; then
          echo "‚úì Nix installed: $(nix --version)"
          echo "  - Auto-optimisation enabled (reduces store size by 25-35%)"
          echo "  - Flakes and nix-command enabled"
        else
          echo "ERROR - Nix installation verification failed" >&2
        fi
      else
        echo "‚úì Nix already installed: $(nix --version)"
      fi

      # Install Devbox (as cloudops user)
      echo "Installing Jetify Devbox..."
      if ! su - cloudops -c 'command -v devbox &>/dev/null'; then
        # Install Devbox CLI
        su - cloudops -c 'curl -fsSL https://get.jetify.com/devbox | bash -s -- -f' || \
          echo "WARNING - Devbox installation failed" >&2

        # Verify Devbox installation
        if su - cloudops -c 'command -v devbox &>/dev/null'; then
          su - cloudops -c 'devbox version' | head -1 | sed 's/^/‚úì Devbox installed: /'

          # Install global CLI tools and Claude CLI infrastructure
          echo "  - Installing global tools: jq, yq, gh, nodejs, pnpm..."
          if ! timeout 600 su - cloudops -c 'devbox global add jq yq gh nodejs@24.11.0 pnpm@10.20.0 --quiet' 2>&1 | grep -v "^$" | sed 's/^/  /'; then
            echo "  WARNING: Global tools installation failed - check network and Nix store" >&2
          fi

          # Initialize devbox global environment
          su - cloudops -c 'eval "$(devbox global shellenv)"' 2>/dev/null || \
            echo "  WARNING - Global shellenv initialization failed (non-critical)" >&2

          # Define PNPM_HOME path (centralized)
          PNPM_HOME="/home/cloudops/.local/share/pnpm"

          # FIX 1: Create PNPM_HOME directory as root BEFORE pnpm installation (prevents race condition)
          echo "  - Creating PNPM_HOME directory: ${PNPM_HOME}"
          mkdir -p "${PNPM_HOME}"
          chown cloudops:cloudops "${PNPM_HOME}"
          chmod 755 "${PNPM_HOME}"

          # Setup pnpm and install Claude CLI
          echo "  - Setting up pnpm and installing Claude CLI..."

          # Create and run pnpm setup
          echo "  - Setting up pnpm..."
          su - cloudops -c 'cd ~ && devbox global run -- bash -c "export SHELL=/bin/bash && pnpm setup"' 2>&1 | grep -v "^$" | sed 's/^/  /' || \
            echo "  WARNING - pnpm setup failed (non-critical)" >&2

          # FIX 3: Verify pnpm availability before attempting Claude CLI installation
          echo "  - Verifying pnpm availability..."
          PNPM_VERSION=$(su - cloudops -c "cd ~ && devbox global run -- pnpm --version" 2>/dev/null | head -1)
          if [ -z "$PNPM_VERSION" ] || ! echo "$PNPM_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "  ERROR - pnpm not available after setup, cannot install Claude CLI" >&2
            echo "  Debug: PNPM_VERSION output was: ${PNPM_VERSION:-empty}" >&2
          else
            echo "  ‚úì pnpm available: version $PNPM_VERSION"

            # FIX 4: Install Claude CLI with timeout to prevent network hangs
            echo "  - Installing Claude CLI (with 300s timeout)..."
            if timeout 300 su - cloudops -c "cd ~ && devbox global run -- bash -c 'export PNPM_HOME=\"${PNPM_HOME}\" && export PATH=\"\${PNPM_HOME}:\${PATH}\" && pnpm add -g @anthropic-ai/claude-code'" 2>&1 | sed 's/^/  /'; then
              echo "  ‚úì Claude CLI installation command completed"
            else
              echo "  WARNING - Claude CLI installation failed or timed out" >&2
            fi

            # FIX 2: Verify Claude CLI installation with proper error handling (no tail -1 masking)
            echo "  - Verifying Claude CLI installation..."
            CLAUDE_VERSION=$(su - cloudops -c "cd ~ && devbox global run -- bash -c 'export PNPM_HOME=\"${PNPM_HOME}\" && export PATH=\"\${PNPM_HOME}:\${PATH}\" && command -v claude &>/dev/null && claude --version 2>&1'" 2>/dev/null)

            if [ -n "$CLAUDE_VERSION" ] && echo "$CLAUDE_VERSION" | grep -q "claude"; then
              echo "  ‚úì Claude CLI installed successfully: $CLAUDE_VERSION"
            else
              echo "  WARNING - Claude CLI verification failed. Output was: ${CLAUDE_VERSION:-none}" >&2
              echo "  This is non-critical and can be installed manually later with: pnpm add -g @anthropic-ai/claude-code" >&2
            fi
          fi
        else
          echo "ERROR - Devbox installation verification failed" >&2
        fi
      else
        su - cloudops -c 'devbox version' | head -1 | sed 's/^/‚úì Devbox already installed: /'
      fi

      # Optimize Nix store to reduce disk usage (final optimization)
      echo "Optimizing Nix store (may take 30-60 seconds)..."
      if command -v nix-store &>/dev/null; then
        nix-store --optimise 2>/dev/null && \
          echo "‚úì Nix store optimized (hard-linked duplicate files)" || \
          echo "WARNING - Nix store optimization skipped (non-critical)" >&2

        # Display final store size
        STORE_SIZE=$(du -sh /nix/store 2>/dev/null | cut -f1)
        echo "  - Nix store size: ${STORE_SIZE:-unknown}"
      fi

      # Create completion marker (last step)
      if [ ! -f /home/cloudops/.setup-complete ]; then
        echo "CloudOps setup completed at $(date)" > /home/cloudops/.setup-complete
        chown cloudops:cloudops /home/cloudops/.setup-complete
      fi

      echo "=== CloudOps Setup Completed Successfully: $(date) ==="
    } 2>&1 | tee -a /var/log/cloudops-setup.log

final_message: |
  ‚úÖ Ubuntu 25.10 CloudOps + Devbox setup complete!

  Default user: cloudops
  Custom bash configuration installed with:
  - Full .bashrc with history, completions, NVM lazy loading
  - Comprehensive .bash_aliases with Git, Docker, Podman, Kubernetes, Azure, Terraform shortcuts
  - Devbox global environment auto-activated

  üöÄ Devbox Development Environment:
  - Nix package manager installed (auto-optimizing store)
  - Jetify Devbox CLI ready
  - Global tools: jq, yq, gh, nodejs (24.11.0), pnpm (10.20.0)
  - ü§ñ Claude CLI installed globally (accessible everywhere)
  - Templates available: ~/.devbox-templates/
    ‚Ä¢ nodejs-webapp.json  - Node.js/TypeScript web apps
    ‚Ä¢ python-api.json    - Python FastAPI/Flask APIs
    ‚Ä¢ go-service.json    - Go microservices
    ‚Ä¢ rust-cli.json      - Rust CLI tools
    ‚Ä¢ fullstack.json     - Multi-language full-stack

  üìñ Quick Start with Devbox:
    # Create a new Node.js project
    mkdir my-app && cd my-app
    cp ~/.devbox-templates/nodejs-webapp.json devbox.json
    devbox shell

    # Or initialize from scratch
    devbox init
    devbox add nodejs@22.14.0
    devbox shell

    # Read the quickstart guide
    cat ~/.devbox-quickstart.md

  üõ†Ô∏è  Maintenance Scripts:
    ~/bin/check-devbox-health.sh  - Verify Devbox, Node.js, pnpm, Claude CLI setup
    ~/bin/update-global-tools.sh  - Update all global tools and Claude CLI

  ü§ñ Using Claude CLI:
    claude --help                 - Show Claude CLI help
    claude "explain this code"    - Ask Claude to help with code
    # Claude CLI is available globally - use it anywhere!

  ‚ö†Ô∏è  IMPORTANT: Customize your configuration
  - Edit ~/.gitconfig to set your personal name and email
  - Edit ~/code/work/.gitconfig to set your work identity
  - Add organization-specific aliases in ~/.bash_aliases if needed

  Git dual-identity structure:
  - Personal git config: ~/.gitconfig
  - Work git config: ~/code/work/.gitconfig (auto-switches in ~/code/work/**)
  - Directory structure: ~/code/work/ created

  Performance optimizations:
  - NVM lazy loading (faster shell startup)
  - Nix store auto-optimization (25-35% size reduction)
  - Devbox caching (fast package installations)
  - Package cache cleaned (reduced disk usage)
  - Lazy-loaded kubectl/helm completions

  To enable bridge networking:
    1. Edit /etc/netplan/60-bridge.yaml
    2. Uncomment and configure the bridge section
    3. Run: sudo netplan apply

  Access your instance:
    multipass shell cloudops

  View setup logs:
    multipass exec cloudops -- cat /var/log/cloudops-setup.log

  Resources:
    - Devbox docs: https://www.jetify.com/devbox/docs
    - Package search: https://www.nixhub.io
    - Templates: ls ~/.devbox-templates/
