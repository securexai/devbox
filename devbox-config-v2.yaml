#cloud-config
# Ubuntu 25.10 - DevBox Configuration (devbox as default user)
#
# IMPORTANT: This is a TEMPLATE configuration with placeholder values.
# Customize the following sections before use:
#   - Git user configuration (lines ~619-650)
#   - Organization-specific aliases (if needed)
#
# Git Configuration Options:
#
#   Option 1: Environment Variables (recommended for automation)
#     multipass launch --name devbox --cloud-init devbox-config-v2.yaml \
#       -e GIT_USER_NAME="Your Name" \
#       -e GIT_USER_EMAIL="your@email.com" \
#       -e GIT_WORK_NAME="Work Name" \
#       -e GIT_WORK_EMAIL="work@company.com"
#
#   Option 2: Manual Edit
#     Edit the git configuration sections below and replace placeholders:
#       - CHANGEME / changeme@example.com (personal config)
#       - CHANGEME / changeme@example.com (work config)
#
# Validation:
#   cloud-init schema --config-file devbox-config-v2.yaml --annotate
#
# Testing:
#   multipass launch --name test-devbox --cloud-init devbox-config-v2.yaml
#   multipass exec test-devbox -- cloud-init status --wait
#   multipass exec test-devbox -- cat /var/log/cloud-init.log
#
# Cleanup:
#   multipass delete test-devbox && multipass purge

hostname: devbox
timezone: America/Bogota
locale: en_US.UTF-8

# User configuration
# SECURITY NOTE: NOPASSWD sudo is convenient for development but reduces security.
# For production environments, remove NOPASSWD to require password authentication.
users:
  - name: devbox
    gecos: DevBox User
    shell: /bin/bash
    groups: [adm, cdrom, dip, plugdev, sudo]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false

# Package management
# Cloud-init execution order: 1) update repos, 2) upgrade existing, 3) install new
package_update: false
package_upgrade: false

packages:
  - build-essential                  # Compilers and build tools (gcc, g++, make)
  - ca-certificates                  # SSL/TLS certificate authorities for HTTPS
  - curl                             # Command-line HTTP client for data transfer
  - dnsutils                         # DNS debugging tools (dig, nslookup)
  - gh                               # GitHub CLI for repository management
  - git                              # Version control system
  - gnupg                            # GPG encryption and signing tools
  - htop                             # Enhanced process viewer
  - jq                               # JSON processor for scripts
  - language-pack-en                 # English language support for system locales
  - locales                          # Locale data files for internationalization
  - lsb-release                      # Linux Standard Base version reporting
  - nano                             # Lightweight command-line text editor
  - net-tools                        # Network utilities (ifconfig, netstat)
  - openssh-client                   # SSH client for remote connections
  - openssh-server                   # SSH server for remote access
  - software-properties-common       # Scripts for managing software repositories
  - tree                             # Directory visualization
  - unzip                            # Extract files from ZIP archives
  - vim                              # Alternative text editor
  - wget                             # Non-interactive HTTP/FTP file downloader

# Configuration files
write_files:
  # Custom .bashrc for devbox user
  - path: /home/devbox/.bashrc
    permissions: '0644'
    content: |
      # ~/.bashrc: executed by bash(1) for non-login shells.
      # see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)
      # for examples

      # If not running interactively, don't do anything
      case $- in
          *i*) ;;
            *) return;;
      esac

      # ============================================================================
      # Shell History Configuration
      # ============================================================================

      # don't put duplicate lines or lines starting with space in the history.
      # See bash(1) for more options
      HISTCONTROL=ignoreboth

      # append to the history file, don't overwrite it
      shopt -s histappend

      # for setting history length see HISTSIZE and HISTFILESIZE in bash(1)
      HISTSIZE=10000
      HISTFILESIZE=20000

      # ============================================================================
      # Shell Options
      # ============================================================================

      # check the window size after each command and, if necessary,
      # update the values of LINES and COLUMNS.
      shopt -s checkwinsize

      # If set, the pattern "**" used in a pathname expansion context will
      # match all files and zero or more directories and subdirectories.
      shopt -s globstar

      # make less more friendly for non-text input files, see lesspipe(1)
      [ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

      # ============================================================================
      # Prompt Configuration
      # ============================================================================

      # set variable identifying the chroot you work in (used in the prompt below)
      if [ -z "${debian_chroot:-}" ] && [ -r /etc/debian_chroot ]; then
          debian_chroot=$(cat /etc/debian_chroot)
      fi

      # set a fancy prompt (non-color, unless we know we "want" color)
      case "$TERM" in
          xterm-color|*-256color) color_prompt=yes;;
      esac

      # uncomment for a colored prompt, if the terminal has the capability; turned
      # off by default to not distract the user: the focus in a terminal window
      # should be on the output of commands, not on the prompt
      #force_color_prompt=yes

      if [ -n "$force_color_prompt" ]; then
          if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
      	# We have color support; assume it's compliant with Ecma-48
      	# (ISO/IEC-6429). (Lack of such support is extremely rare, and such
      	# a case would tend to support setf rather than setaf.)
      	color_prompt=yes
          else
      	color_prompt=
          fi
      fi

      if [ "$color_prompt" = yes ]; then
          PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
      else
          PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
      fi
      unset color_prompt force_color_prompt

      # If this is an xterm set the title to user@host:dir
      case "$TERM" in
      xterm*|rxvt*)
          PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
          ;;
      *)
          ;;
      esac

      # ============================================================================
      # Color Support
      # ============================================================================

      # enable color support of ls and also add handy aliases
      if [ -x /usr/bin/dircolors ]; then
          test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
          alias ls='ls --color=auto'
          #alias dir='dir --color=auto'
          #alias vdir='vdir --color=auto'

          alias grep='grep --color=auto'
          alias fgrep='fgrep --color=auto'
          alias egrep='egrep --color=auto'
      fi

      # colored GCC warnings and errors
      #export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

      # ============================================================================
      # Built-in Aliases
      # ============================================================================

      # Add an "alert" alias for long running commands.  Use like so:
      #   sleep 10; alert
      alias alert='notify-send --urgency=low -i "$([ $? = 0 ] && echo terminal || echo error)" "$(history|tail -n1|sed -e '\''s/^\s*[0-9]\+\s*//;s/[;&|]\s*alert$//'\'')"'

      # ============================================================================
      # Bash Completion
      # ============================================================================

      # enable programmable completion features (you don't need to enable
      # this, if it's already enabled in /etc/bash.bashrc and /etc/profile
      # sources /etc/bash.bashrc).
      if ! shopt -oq posix; then
        if [ -f /usr/share/bash-completion/bash_completion ]; then
          . /usr/share/bash-completion/bash_completion
        elif [ -f /etc/bash_completion ]; then
          . /etc/bash_completion
        fi
      fi

      # ============================================================================
      # User Aliases
      # ============================================================================

      # Alias definitions.
      # You may want to put all your additions into a separate file like
      # ~/.bash_aliases, instead of adding them here directly.
      # See /usr/share/doc/bash-doc/examples in the bash-doc package.

      if [ -f ~/.bash_aliases ]; then
          . ~/.bash_aliases
      fi

      # ============================================================================
      # Tool Initialization
      # ============================================================================

      # === NVM (Node Version Manager) - Lazy Loading ===
      # Lazy load NVM to improve shell startup time (saves ~200-500ms)
      # NVM will be loaded on first use of nvm, node, npm, or npx commands
      #
      # IMPORTANT - Tab Completion Behavior:
      # Tab completion for npm/npx will NOT work until you run one of these commands
      # for the first time in your shell session. This is a trade-off for faster startup.
      #
      # Example workflow:
      #   $ npm <TAB>        # ← Tab completion won't work yet
      #   $ npm --version    # ← First use loads NVM
      #   $ npm <TAB>        # ← Now tab completion works for rest of session
      #
      # After first use, completion works normally for all npm/npx commands.
      # NVM and node tab completion work immediately as they load the completion system.
      export NVM_DIR="$HOME/.nvm"

      # Define the NVM loader function once (DRY principle)
      _load_nvm() {
          unset -f nvm node npm npx _load_nvm
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
      }

      # Lazy load wrappers - each command loads NVM on first use
      nvm() { _load_nvm; nvm "$@"; }
      node() { _load_nvm; node "$@"; }

      npm() {
        _load_nvm
        if command -v npm &>/dev/null; then
          npm "$@"
        else
          echo "npm not found. Install Node.js via 'nvm install node'" >&2
          return 127
        fi
      }

      npx() {
        _load_nvm
        if command -v npx &>/dev/null; then
          npx "$@"
        else
          echo "npx not found. Install Node.js via 'nvm install node'" >&2
          return 127
        fi
      }

      # === Bun JavaScript Runtime ===
      export BUN_INSTALL="$HOME/.bun"
      export PATH="$BUN_INSTALL/bin:$PATH"

      # ============================================================================
      # Lazy-Loading Completions (improves shell startup time)
      # ============================================================================

      # kubectl completion - one-time load on first use
      kubectl() {
          unset -f kubectl
          if command -v kubectl &>/dev/null; then
              source <(command kubectl completion bash 2>/dev/null)
              complete -o default -F __start_kubectl k
          fi
          kubectl "$@"
      }

      # helm completion - one-time load on first use
      helm() {
          unset -f helm
          if [ -f /etc/bash_completion.d/helm ]; then
              source /etc/bash_completion.d/helm
          elif command -v helm &>/dev/null; then
              source <(command helm completion bash 2>/dev/null)
          fi
          helm "$@"
      }

      # ============================================================================
      # PATH Configuration (consolidated)
      # ============================================================================

      # Local binaries (Terraform, custom tools)
      export PATH="$HOME/.local/bin:$PATH"

      # ============================================================================
      # Tool-Specific Configuration
      # ============================================================================

      # === Terraform ===
      if command -v terraform &>/dev/null; then
          complete -C "$(command -v terraform)" terraform
      fi

      # === kubectl Configuration ===
      # Only set VS Code as kubectl editor if both tools are available
      if command -v code &>/dev/null && command -v kubectl &>/dev/null; then
          export KUBE_EDITOR="code --wait"
      fi

      # === Cargo (Rust) Environment ===
      if [ -f "$HOME/.cargo/env" ]; then
          . "$HOME/.cargo/env"
      fi

  # Custom .bash_aliases for devbox user
  - path: /home/devbox/.bash_aliases
    permissions: '0644'
    content: |
      # ~/.bash_aliases
      # Custom aliases for enhanced productivity

      # ============================================================================
      # Navigation & Safety
      # ============================================================================

      # Directory navigation shortcuts
      alias ..='cd ..'
      alias ...='cd ../..'
      alias ....='cd ../../..'
      alias .....='cd ../../../..'
      alias -- -='cd -'  # Go back to previous directory

      # Safety aliases (interactive mode for destructive operations)
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'
      alias ln='ln -i'

      # Enhanced ls commands
      alias l='ls -CF'
      alias la='ls -A'
      alias ll='ls -alF'
      alias lh='ls -lh'
      alias lt='ls -ltr'  # Sort by time, most recent last
      alias lsize='ls -lhS'  # Sort by size

      # ============================================================================
      # Git Shortcuts
      # ============================================================================

      alias g='git'
      alias gs='git status'
      alias gss='git status -s'  # Short format
      alias ga='git add'
      alias gaa='git add --all'
      alias gap='git add -p'  # Interactive staging
      alias gc='git commit'
      alias gcm='git commit -m'
      alias gca='git commit --amend'
      alias gcan='git commit --amend --no-edit'
      alias gp='git push'
      alias gpf='git push --force-with-lease'  # Safer force push
      alias gl='git pull'
      alias gf='git fetch'
      alias gco='git checkout'
      alias gcb='git checkout -b'
      alias gb='git branch'
      alias gba='git branch -a'
      alias gbd='git branch -d'
      alias gbD='git branch -D'
      alias gd='git diff'
      alias gds='git diff --staged'
      alias glog='git log --oneline --graph --decorate'
      alias gloga='git log --oneline --graph --decorate --all'
      alias glogp='git log --pretty=format:"%h %ad | %s%d [%an]" --graph --date=short'
      alias gstash='git stash'
      alias gstashp='git stash pop'
      alias gm='git merge'
      alias gr='git rebase'
      alias gri='git rebase -i'
      alias grc='git rebase --continue'
      alias gra='git rebase --abort'
      alias greset='git reset'
      alias gresethard='git reset --hard'
      alias gclean='git clean -fd'
      alias gshow='git show'
      alias gtag='git tag'

      # ============================================================================
      # Podman Aliases
      # ============================================================================

      alias p='podman'
      alias pps='podman ps'
      alias ppsa='podman ps -a'
      alias pimg='podman images'
      alias pbuild='podman build'
      alias prun='podman run'
      alias prm='podman rm'
      alias prmi='podman rmi'
      alias pstop='podman stop'
      alias pstart='podman start'
      alias prestart='podman restart'
      alias pexec='podman exec -it'
      alias plog='podman logs'
      alias plogf='podman logs -f'
      alias pinspect='podman inspect'
      alias ppull='podman pull'
      alias ppush='podman push'
      alias pprune='podman system prune -a'
      alias pvolume='podman volume'
      alias pnetwork='podman network'
      alias ppod='podman pod'

      # Podman compose aliases
      alias pc='podman-compose'
      alias pcup='podman-compose up -d'
      alias pcdown='podman-compose down'
      alias pclogs='podman-compose logs'
      alias pclogsf='podman-compose logs -f'
      alias pcrestart='podman-compose restart'
      alias pcbuild='podman-compose build'

      # ============================================================================
      # Docker Aliases
      # ============================================================================

      alias d='docker'
      alias dps='docker ps'
      alias dpsa='docker ps -a'
      alias dimg='docker images'
      alias dbuild='docker build'
      alias drun='docker run'
      alias drm='docker rm'
      alias drmi='docker rmi'
      alias dstop='docker stop'
      alias dstart='docker start'
      alias drestart='docker restart'
      alias dexec='docker exec -it'
      alias dlog='docker logs'
      alias dlogf='docker logs -f'
      alias dinspect='docker inspect'
      alias dpull='docker pull'
      alias dpush='docker push'
      alias dprune='docker system prune -a'
      alias dvolume='docker volume'
      alias dnetwork='docker network'

      # Docker compose aliases
      alias dc='docker-compose'
      alias dcup='docker-compose up -d'
      alias dcdown='docker-compose down'
      alias dclogs='docker-compose logs'
      alias dclogsf='docker-compose logs -f'
      alias dcrestart='docker-compose restart'
      alias dcbuild='docker-compose build'

      # ============================================================================
      # Kubernetes & kubectl Aliases
      # ============================================================================

      alias k='kubectl'
      alias kgp='kubectl get pods'
      alias kgpa='kubectl get pods --all-namespaces'
      alias kgd='kubectl get deployments'
      alias kgs='kubectl get services'
      alias kgn='kubectl get nodes'
      alias kgi='kubectl get ingress'
      alias kgpvc='kubectl get pvc'
      alias kgcm='kubectl get configmaps'
      alias kgsec='kubectl get secrets'

      alias kdesc='kubectl describe'
      alias kdescp='kubectl describe pod'
      alias kdescd='kubectl describe deployment'
      alias kdescs='kubectl describe service'

      alias klog='kubectl logs'
      alias klogf='kubectl logs -f'
      alias klogp='kubectl logs -p'  # Previous container

      alias kexec='kubectl exec -it'
      alias kpf='kubectl port-forward'
      alias kdel='kubectl delete'
      alias kapp='kubectl apply -f'
      alias kedit='kubectl edit'

      alias kctx='kubectl config current-context'
      alias kns='kubectl config set-context --current --namespace'
      alias kgetns='kubectl get namespaces'

      # ============================================================================
      # Azure CLI Aliases
      # ============================================================================

      alias azlogin='az login'
      alias azaccount='az account show'
      alias azlist='az account list --output table'
      alias azrg='az group list --output table'
      alias azaks='az aks list --output table'
      alias aksget='az aks get-credentials'

      # Add organization-specific aliases here
      # Example:
      # alias azsetdev='az account set --subscription YOUR_SUBSCRIPTION_ID'
      # alias kdev='az aks get-credentials --resource-group YOUR_RG --name YOUR_CLUSTER'

      # ============================================================================
      # Terraform Aliases
      # ============================================================================

      alias tf='terraform'
      alias tfinit='terraform init'
      alias tfplan='terraform plan'
      alias tfapply='terraform apply'
      alias tfdestroy='terraform destroy'
      alias tfvalidate='terraform validate'
      alias tffmt='terraform fmt'
      alias tfoutput='terraform output'
      alias tfshow='terraform show'
      alias tfstate='terraform state'
      alias tfws='terraform workspace'
      alias tfwslist='terraform workspace list'
      alias tfwsselect='terraform workspace select'
      alias tfwsnew='terraform workspace new'

      # ============================================================================
      # pnpm & Node.js Aliases
      # ============================================================================

      alias pn='pnpm'
      alias pi='pnpm install'
      alias pd='pnpm dev'
      alias pb='pnpm build'
      alias pt='pnpm test'
      alias pl='pnpm lint'
      alias plf='pnpm lint:fix'
      alias pstart='pnpm start'
      alias ppr='pnpm prettier:write'
      alias pcheck='pnpm check-types'

      # ============================================================================
      # System & Utilities
      # ============================================================================

      # Disk usage
      alias df='df -h'
      alias du='du -h'
      alias dus='du -sh'

      # Process management
      alias psg='ps aux | grep -v grep | grep -i -e VSZ -e'
      alias psgrep='ps aux | grep'

      # Network
      alias ports='netstat -tulanp'
      alias myip='curl ifconfig.me'

      # History
      alias h='history'
      alias hg='history | grep'

      # Quick directory jumps
      # Add your project-specific shortcuts here
      # Example:
      # alias myproject='cd ~/code/myproject'

      # Reload bash config
      alias reload='source ~/.bashrc'
      alias editbash='code ~/.bashrc ~/.bash_aliases'

      # ============================================================================
      # Miscellaneous
      # ============================================================================

      # Make directory and cd into it
      mkcd() {
          mkdir -p "$1" && cd "$1"
      }

      # Extract compressed files
      extract() {
          if [ -f "$1" ]; then
              case "$1" in
                  *.tar.bz2)   tar xjf "$1"     ;;
                  *.tar.gz)    tar xzf "$1"     ;;
                  *.bz2)       bunzip2 "$1"     ;;
                  *.rar)       unrar x "$1"     ;;
                  *.gz)        gunzip "$1"      ;;
                  *.tar)       tar xf "$1"      ;;
                  *.tbz2)      tar xjf "$1"     ;;
                  *.tgz)       tar xzf "$1"     ;;
                  *.zip)       unzip "$1"       ;;
                  *.Z)         uncompress "$1"  ;;
                  *.7z)        7z x "$1"        ;;
                  *)           echo "'$1' cannot be extracted via extract()" ;;
              esac
          else
              echo "'$1' is not a valid file"
          fi
      }

      # Find files by name
      ff() {
          find . -type f -iname "*$1*"
      }

      # Find directories by name
      fdir() {
          find . -type d -iname "*$1*"
      }

  # Git configuration - Personal (template)
  # Note: This template will be processed by runcmd to support environment variables
  # TEMPLATE: Replace YOUR_NAME and YOUR_EMAIL with your actual information
  # OR: Pass via environment variables: GIT_USER_NAME and GIT_USER_EMAIL
  - path: /home/devbox/.gitconfig.template
    permissions: '0644'
    content: |
      [user]
          name = __GIT_USER_NAME__
          email = __GIT_USER_EMAIL__
      [includeIf "gitdir/i:~/code/work/**"]
          path = ~/code/work/.gitconfig
      [core]
          editor = code --wait
          hooksPath = ~/.git-hooks
          autocrlf = input
      [init]
          defaultBranch = main
      [pull]
          rebase = true
      [fetch]
          prune = true
      [push]
          default = current
          autoSetupRemote = true
      [alias]
          st = status -sb
          lg = log --graph --oneline --decorate --all

  # Git configuration - Work (template)
  # Note: This template will be processed by runcmd to support environment variables
  # TEMPLATE: Replace WORK_NAME and WORK_EMAIL with your work information
  # OR: Pass via environment variables: GIT_WORK_NAME and GIT_WORK_EMAIL
  - path: /tmp/gitconfig-work.template
    permissions: '0644'
    content: |
      [user]
          name = __GIT_WORK_NAME__
          email = __GIT_WORK_EMAIL__

  # Netplan configuration for bridge networking (commented template)
  - path: /etc/netplan/60-bridge.yaml
    permissions: '0644'
    content: |
      # Bridge Network Configuration
      # Edit this file to enable bridge networking
      #
      # network:
      #   version: 2
      #   ethernets:
      #     eth0:
      #       dhcp4: false
      #       dhcp6: false
      #   bridges:
      #     br0:
      #       interfaces: [eth0]
      #       dhcp4: true
      #       # Or use static IP:
      #       # addresses: [192.168.1.100/24]
      #       # routes:
      #       #   - to: default
      #       #     via: 192.168.1.1
      #       # nameservers:
      #       #   addresses: [8.8.8.8, 8.8.4.4]
      #
      # After editing, apply with: sudo netplan apply

# Commands to run after setup
runcmd:
  # Execute all setup commands in a single logged block with error handling
  - |
    {
      set -euo pipefail
      echo "=== DevBox Setup Started: $(date) ==="

      # Create directory structure
      echo "Creating directory structure..."
      mkdir -p /home/devbox/code/work || {
        echo "ERROR: Failed to create directory structure" >&2
        exit 1
      }

      # Verify directory was created
      if [ ! -d /home/devbox/code/work ]; then
        echo "ERROR: Directory /home/devbox/code/work does not exist" >&2
        exit 1
      fi

      # Move work git config template to proper location
      if [ -f /tmp/gitconfig-work.template ]; then
        mv /tmp/gitconfig-work.template /home/devbox/code/work/.gitconfig.template || {
          echo "ERROR: Failed to move work git config template" >&2
          exit 1
        }
      fi

      # Set ownership for all devbox files
      echo "Setting file ownership..."
      chown -R devbox:devbox /home/devbox || {
        echo "ERROR: Failed to set ownership" >&2
        exit 1
      }

      # Process git configuration templates with environment variables
      echo "Processing git configuration templates..."

      # Set default values if environment variables are not provided
      GIT_USER_NAME="${GIT_USER_NAME:-CHANGEME}"
      GIT_USER_EMAIL="${GIT_USER_EMAIL:-changeme@example.com}"
      GIT_WORK_NAME="${GIT_WORK_NAME:-CHANGEME}"
      GIT_WORK_EMAIL="${GIT_WORK_EMAIL:-changeme@example.com}"

      # Warn if using placeholders
      if [ "$GIT_USER_NAME" = "CHANGEME" ] || [ "$GIT_USER_EMAIL" = "changeme@example.com" ]; then
        echo "WARNING: Git personal config using placeholder values. Set GIT_USER_NAME and GIT_USER_EMAIL" >&2
      fi

      if [ "$GIT_WORK_NAME" = "CHANGEME" ] || [ "$GIT_WORK_EMAIL" = "changeme@example.com" ]; then
        echo "WARNING: Git work config using placeholder values. Set GIT_WORK_NAME and GIT_WORK_EMAIL" >&2
      fi

      # Process personal git config
      if [ -f /home/devbox/.gitconfig.template ]; then
        awk -v name="$GIT_USER_NAME" -v email="$GIT_USER_EMAIL" \
            '{gsub(/__GIT_USER_NAME__/, name); gsub(/__GIT_USER_EMAIL__/, email); print}' \
            /home/devbox/.gitconfig.template > /home/devbox/.gitconfig

        if [ -s /home/devbox/.gitconfig ]; then
          chown devbox:devbox /home/devbox/.gitconfig
          chmod 644 /home/devbox/.gitconfig
          rm -f /home/devbox/.gitconfig.template
          echo "Personal git config created with user: ${GIT_USER_NAME}"
        else
          echo "ERROR: Failed to create personal git config" >&2
          exit 1
        fi
      else
        echo "WARNING: Personal git config template not found" >&2
      fi

      # Process work git config
      if [ -f /home/devbox/code/work/.gitconfig.template ]; then
        awk -v name="$GIT_WORK_NAME" -v email="$GIT_WORK_EMAIL" \
            '{gsub(/__GIT_WORK_NAME__/, name); gsub(/__GIT_WORK_EMAIL__/, email); print}' \
            /home/devbox/code/work/.gitconfig.template > /home/devbox/code/work/.gitconfig

        if [ -s /home/devbox/code/work/.gitconfig ]; then
          chown devbox:devbox /home/devbox/code/work/.gitconfig
          chmod 644 /home/devbox/code/work/.gitconfig
          rm -f /home/devbox/code/work/.gitconfig.template
          echo "Work git config created with user: ${GIT_WORK_NAME}"
        else
          echo "ERROR: Failed to create work git config" >&2
          exit 1
        fi
      else
        echo "WARNING: Work git config template not found" >&2
      fi

      # Add auto-switch to devbox user (idempotent)
      echo "Configuring auto-switch to devbox user..."
      if ! grep -q "DEVBOX_SWITCHED" /home/ubuntu/.bashrc 2>/dev/null; then
        echo 'if [ -t 0 ] && [ "$USER" = "ubuntu" ] && [ -z "$DEVBOX_SWITCHED" ]; then export DEVBOX_SWITCHED=1; exec sudo -i -u devbox; fi' >> /home/ubuntu/.bashrc
      fi

      # Clean up package cache to reduce disk usage
      echo "Cleaning package cache..."
      apt-get clean || echo "WARNING: apt-get clean failed (non-critical)"
      rm -rf /var/cache/apt/archives/* || echo "WARNING: Cache cleanup failed (non-critical)"

      # Create completion marker (last step)
      if [ ! -f /home/devbox/.setup-complete ]; then
        echo "DevBox setup completed at $(date)" > /home/devbox/.setup-complete
        chown devbox:devbox /home/devbox/.setup-complete
      fi

      echo "=== DevBox Setup Completed Successfully: $(date) ==="
    } 2>&1 | tee -a /var/log/devbox-setup.log

final_message: |
  ✅ Ubuntu 25.10 DevBox setup complete!

  Default user: devbox
  Custom bash configuration installed with:
  - Full .bashrc with history, completions, NVM lazy loading
  - Comprehensive .bash_aliases with Git, Docker, Podman, Kubernetes, Azure, Terraform shortcuts

  ⚠️  IMPORTANT: Customize your configuration
  - Edit ~/.gitconfig to set your personal name and email
  - Edit ~/code/work/.gitconfig to set your work identity
  - Add organization-specific aliases in ~/.bash_aliases if needed

  Git dual-identity structure:
  - Personal git config: ~/.gitconfig
  - Work git config: ~/code/work/.gitconfig (auto-switches in ~/code/work/**)
  - Directory structure: ~/code/work/ created

  Performance optimizations:
  - NVM lazy loading (faster shell startup)
  - Package cache cleaned (reduced disk usage)
  - Lazy-loaded kubectl/helm completions

  To enable bridge networking:
    1. Edit /etc/netplan/60-bridge.yaml
    2. Uncomment and configure the bridge section
    3. Run: sudo netplan apply

  Access your instance:
    multipass shell devbox

  View setup logs:
    multipass exec devbox -- cat /var/log/devbox-setup.log